<!DOCTYPE html>
<html>
  <head>
    <title>Carte</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <style>
      html,
      body {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
      }
      #map {
        position: absolute;
        top: 0;
        bottom: 0;
        right: 0;
        left: 0;
      }
    </style>
  </head>
  <body>
    <button
      id="bouton_gares"
      style="
        position: absolute;
        top: 10px;
        right: 10px;
        height: 25px;
        width: auto;
        z-index: 9999;
      "
    >
      gares
    </button>
    <button
      id="bouton_gares_tgv"
      style="
        display: none;
        position: absolute;
        top: 40px;
        right: 10px;
        height: 25px;
        width: auto;
        z-index: 9999;
      "
    >
      gares_tgv
    </button>
    <button
      id="bouton_gares_intercites"
      style="
        display: none;
        position: absolute;
        top: 70px;
        right: 10px;
        height: 25px;
        width: auto;
        z-index: 9999;
      "
    >
      gares_intercites
    </button>
    <button
      id="bouton_gares_ter"
      style="
        display: none;
        position: absolute;
        top: 100px;
        right: 10px;
        height: 25px;
        width: auto;
        z-index: 9999;
      "
    >
      gares_ter
    </button>
    <button
      id="bouton_villes"
      style="
        position: absolute;
        top: 10px;
        right: 70px;
        height: 25px;
        width: auto;
        z-index: 9999;
      "
    >
      villes
    </button>
    <input
      type="checkbox"
      id="bouton_checkbox_connexion"
      name="connexions"
      style="
        position: absolute;
        top: 10px;
        right: 120px;
        height: 25px;
        width: auto;
        z-index: 9999;
      "
    />
    <label
      for="bouton_checkbox_connexion"
      style="
        position: absolute;
        background-color: white;
        border: solid black 1px;
        top: 10px;
        right: 140px;
        height: 23.4px;
        width: auto;
        z-index: 9999;
        user-select: none;
      "
      >Connexions</label
    >
    <button
      id="bouton_clear"
      style="
        position: absolute;
        top: 10px;
        right: 225px;
        height: 25px;
        width: auto;
        z-index: 9999;
      "
    >
      X
    </button>
    <!-- Affichage de la carte -->
    <div id="map"></div>

    <script>
      var map = L.map("map").setView([46.6031, 1.8883], 6);
      console.log("La carte a été créée avec succès.");
      // Ajoutez une couche de carte (par exemple, OpenStreetMap)
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "© OpenStreetMap contributors",
      }).addTo(map);

      map.on("click", function (e) {
        var lat = e.latlng.lat;
        var lon = e.latlng.lng;
        console.log("Clicked at:", lat, lon);

        var marker = L.marker([lat, lon]).addTo(map);

        // Send the coordinates to the server
        fetch("/update_marker", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
          },
          body: `lat=${lat}&lon=${lon}`,
        })
          .then((response) => response.json())
          .then((data) => updateMapWithLatestCoordinates(data));
      });

      function updateMapWithLatestCoordinates(data) {
        var lat = data.lat;
        var lon = data.lon;

        // Add a marker to the map
        var marker = L.marker([lat, lon]).addTo(map);

        console.log("Latest Coordinates:", lat, lon);
      }

      // Gestionnaire d'événements pour le bouton
      document
        .getElementById("bouton_gares")
        .addEventListener("click", function (e) {
          affichage =
            document.getElementById("bouton_gares_tgv").style.display === "none"
              ? "block"
              : "none";
          document.getElementById("bouton_gares_tgv").style.display = affichage;
          document.getElementById("bouton_gares_ter").style.display = affichage;
          document.getElementById("bouton_gares_intercites").style.display =
            affichage;
        });
      document
        .getElementById("bouton_gares_tgv")
        .addEventListener("click", function (e) {
          get_localisation(e.target.innerText);
        });
      document
        .getElementById("bouton_gares_ter")
        .addEventListener("click", function (e) {
          get_localisation(e.target.innerText);
        });
      document
        .getElementById("bouton_gares_intercites")
        .addEventListener("click", function (e) {
          get_localisation(e.target.innerText);
        });

      document
        .getElementById("bouton_villes")
        .addEventListener("click", function (e) {
          get_localisation(e.target.innerText);
        });
      document
        .getElementById("bouton_clear")
        .addEventListener("click", function (e) {
          map.eachLayer(function (layer) {
            if (layer instanceof L.Marker || layer instanceof L.Polyline) {
              map.removeLayer(layer);
            }
          });
        });

      function get_localisation(bouton) {
        // Appel de la fonction pour mettre à jour la carte avec les dernières coordonnées
        let checkbox = document.querySelector(
          "#bouton_checkbox_connexion"
        ).checked;

        console.log(bouton);

        let map_button = {
          villes: 0,
          gares_tgv: 1,
          gares_intercites: 2,
          gares_ter: 3,
        };

        fetch("/get_localisation", {
          method: "GET",
        })
          .then((response) => response.json())
          .then((data) => {
            console.log(data);
            update_markers(data[map_button[bouton]][0]);
            if (checkbox)
              update_connexions(
                data[map_button[bouton]][0],
                data[map_button[bouton]][1]
              );
          });
      }

      function update_markers(localisations) {
        // Ajouter des marqueurs pour chaque ville
        for (const key in localisations) {
          let nom = key;
          let coordonees = localisations[key];
          let latitude = coordonees[0];
          let longitude = coordonees[1];

          // Choisir la couleur du marqueur en fonction de la ville
          let markerColor = "blue"; // Vous pouvez personnaliser cela selon vos besoins
          let markerIcon = new L.Icon({
            iconUrl:
              "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-" +
              markerColor +
              ".png",
            shadowUrl:
              "https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41],
          });

          L.marker([latitude, longitude], {
            icon: markerIcon,
          })
            .addTo(map)
            .bindPopup(nom);
        }
      }

      function update_connexions(localisations, connexions) {
        // Ajouter des connexions entre les villes
        connexions.forEach(([nom1, nom2, temps]) => {
          const [latitude1, longitude1] = localisations[nom1];
          const [latitude2, longitude2] = localisations[nom2];

          let polyline = L.polyline(
            [
              [latitude1, longitude1],
              [latitude2, longitude2],
            ],
            { color: "blue", weight: 2 }
          ).addTo(map);
          // Ajouter un popup avec le temps sur la polyline
          polyline.bindPopup("Temps de trajet : " + temps + " minutes");
        });
      }
    </script>
  </body>
</html>
